# -*- coding: utf-8 -*-
"""Loan Prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1aECkxfoNiwpcvQ3Mutbtf0g5OS5uFujL

##Import the libraries
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection  import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, classification_report
import warnings
warnings.filterwarnings("ignore")

train = pd.read_csv('/content/train_u6lujuX_CVtuZ9i.csv')
test = pd.read_csv('/content/test_Y3wMUE5_7gLdaTN.csv')
train.head()

print(f'train_shape{train.shape}')
print(f'test_shape{test.shape}')

train.info()

pd.DataFrame({'count': train.shape[0],
              'nulls': train.isnull().sum(),
              'nulls%': train.isnull().mean() * 100,
              'cardinality': train.nunique(),
             })

pd.DataFrame({'count': test.shape[0],
              'nulls': test.isnull().sum(),
              'nulls%': test.isnull().mean() * 100,
              'cardinality': test.nunique(),
             })

print(f'train_duplicated: {train.duplicated().sum()}')
print(f'test_duplicated: {test.duplicated().sum()}')

for col in ["Gender", "Married","Dependents", "Self_Employed", "Credit_History"]:
    train[col].fillna(train[col].mode()[0], inplace=True)

for col in ["ApplicantIncome", "CoapplicantIncome", "LoanAmount", "Loan_Amount_Term"]:
    train[col].fillna(train[col].mean(), inplace=True)

for col in ["Gender", "Dependents", "Self_Employed", "Credit_History"]:
    test[col].fillna(test[col].mode()[0], inplace=True)

for col in ["LoanAmount", "Loan_Amount_Term"]:
    test[col].fillna(test[col].mean(), inplace=True)

train.drop("Loan_ID", axis=1, inplace=True)
test.drop("Loan_ID", axis=1, inplace=True)

train.describe()

train.corr(numeric_only=True)

"""##Outliers"""

train.skew(numeric_only=True)

plt.figure(figsize=(10, 8))
plt.boxplot([train['ApplicantIncome'], train['CoapplicantIncome']], labels=['Applicant', 'Coapplicant'], notch=True)
#plt.boxplot(train.values(), notch=True, labels=train.keys())  # Create the box plot with notches
plt.title('ApplicantIncome and CoapplicantIncome')
plt.ylabel('Income (in $1000s)')  # Label the y-axis
plt.grid(True, linestyle='--', alpha=0.7)  # Add grid lines with dashed style and 70% opacity

plt.show()  # Display the plot

train["ApplicantIncome"] = np.log1p(train["ApplicantIncome"])
train["CoapplicantIncome"] = np.log1p(train["CoapplicantIncome"])

plt.figure(figsize=(10, 8))
plt.boxplot([train['ApplicantIncome'], train['CoapplicantIncome']], labels=['Applicant', 'Coapplicant'], notch=True)
#plt.boxplot(train.values(), notch=True, labels=train.keys())  # Create the box plot with notches
plt.title('ApplicantIncome and CoapplicantIncome')
plt.ylabel('Income (in $1000s)')  # Label the y-axis
plt.grid(True, linestyle='--', alpha=0.7)  # Add grid lines with dashed style and 70% opacity

plt.show()  # Display the plot

"""##Analysis"""

train['Gender'].value_counts()

train['Married'].value_counts()

train['Education'].value_counts()

train['Self_Employed'].value_counts()

train['Credit_History'].value_counts()

train['Loan_Status'].value_counts()

def pie(col):
    plt.pie(
        train[col].value_counts(),
        labels=train[col].value_counts().index,
        autopct='%0.1f%%',
        startangle=140,
        colors=['#66b3ff', '#ff9999'],
        explode=(0.1, 0),
        shadow=True,
        wedgeprops=dict(width=0.7, edgecolor='w')
    )

    plt.title(col, fontsize=22, fontweight='bold')

    plt.legend(
        title=col,
        title_fontsize='18',
        loc='upper left',
        bbox_to_anchor=(1, 1)
    )

plt.figure(figsize=(18, 10))
columns = ['Gender', 'Married', 'Self_Employed', 'Education', 'Credit_History', 'Loan_Status']
i = 1
for col in columns:
    plt.subplot(2, 3, i)
    pie(col)
    i += 1

plt.tight_layout()
plt.show()

plt.figure(figsize=(12, 8))
plt.hist(train['ApplicantIncome'], bins=15, color='lightblue', edgecolor='black')

plt.xlabel('Income')
plt.ylabel('Frequency')
plt.title('Distribution of Applicant Income')

plt.show()

plt.figure(figsize=(12, 8))
plt.hist(train['CoapplicantIncome'], bins=15, color='lightblue', edgecolor='black')

plt.xlabel('Income')
plt.ylabel('Frequency')
plt.title('Distribution of Coapplicant Income')

plt.show()

plt.figure(figsize=(12, 8))
plt.hist(train['LoanAmount'], bins=15, color='lightblue', edgecolor='black')

plt.xlabel('LoanAmount')
plt.ylabel('Frequency')
plt.title('Distribution of Loan Amount')

plt.show()

plt.figure(figsize=(12, 8))
plt.hist(train['Loan_Amount_Term'], bins=15, color='lightblue', edgecolor='black')

plt.xlabel('Loan Amount Term')
plt.ylabel('Frequency')
plt.title('Distribution of Loan Amount Trem')

plt.show()

train['LoanAmount'].describe()

train

"""##Preprocessing"""

columns = ["Gender", "Married", "Dependents", "Education", "Self_Employed", 'Property_Area']
encoders = {}
for col in columns:
    label = LabelEncoder()
    train[col] = label.fit_transform(train[col])
    test[col] = label.transform(test[col])
    encoders[col] = label

train["Loan_Status"] = train["Loan_Status"].map({'N':0, 'Y':1})

X = train.drop(columns = ["Loan_Status"], axis=1)
y = train["Loan_Status"]

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42, stratify=y)

scaler = StandardScaler()
X_train = scaler.fit_transform(X_train)
X_test = scaler.transform(X_test)

"""##Model random forest"""

model = RandomForestClassifier(n_estimators=100, random_state=42, class_weight="balanced")

model.fit(X_train, y_train)

y_pred = model.predict(X_test)
print("Accuracy:", accuracy_score(y_test, y_pred))
print("Classification Report:\n", classification_report(y_test, y_pred))

importances = pd.Series(model.feature_importances_, index=X.columns).sort_values(ascending=False)

print(importances)

plt.figure(figsize=(10,6))
importances.head(10).plot(kind='bar')
plt.title("Top Feature Importances")
plt.ylabel("Importance Score")
plt.show()